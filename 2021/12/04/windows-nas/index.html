<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>P340 工作站搭建家庭服务器 | NOWHERE</title>
  <meta name="author" content="Yubo Qin" />
  <meta name="description" content="一些碎碎念" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/blog/favicon/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/blog/favicon/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/blog/favicon/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/blog/favicon/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/blog/favicon/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/blog/favicon/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/blog/favicon/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/blog/favicon/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="/images/blog/favicon/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="/images/blog/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="/images/blog/favicon/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/images/blog/favicon/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="/images/blog/favicon/favicon-128.png" sizes="128x128" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200;300;400;500;600;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">

  <meta name="generator" content="NOWHERE">

  
  
  
</head>


<body class="post-template">

  <!-- Generated using IconMoon -->
<svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
  <symbol id="icon-facebook2" viewBox="0 0 32 32">
  <path d="M29 0h-26c-1.65 0-3 1.35-3 3v26c0 1.65 1.35 3 3 3h13v-14h-4v-4h4v-2c0-3.306 2.694-6 6-6h4v4h-4c-1.1 0-2 0.9-2 2v2h6l-1 4h-5v14h9c1.65 0 3-1.35 3-3v-26c0-1.65-1.35-3-3-3z"></path>
  </symbol>
  <symbol id="icon-twitter" viewBox="0 0 32 32">
  <path d="M32 7.075c-1.175 0.525-2.444 0.875-3.769 1.031 1.356-0.813 2.394-2.1 2.887-3.631-1.269 0.75-2.675 1.3-4.169 1.594-1.2-1.275-2.906-2.069-4.794-2.069-3.625 0-6.563 2.938-6.563 6.563 0 0.512 0.056 1.012 0.169 1.494-5.456-0.275-10.294-2.888-13.531-6.862-0.563 0.969-0.887 2.1-0.887 3.3 0 2.275 1.156 4.287 2.919 5.463-1.075-0.031-2.087-0.331-2.975-0.819 0 0.025 0 0.056 0 0.081 0 3.181 2.263 5.838 5.269 6.437-0.55 0.15-1.131 0.231-1.731 0.231-0.425 0-0.831-0.044-1.237-0.119 0.838 2.606 3.263 4.506 6.131 4.563-2.25 1.762-5.075 2.813-8.156 2.813-0.531 0-1.050-0.031-1.569-0.094 2.913 1.869 6.362 2.95 10.069 2.95 12.075 0 18.681-10.006 18.681-18.681 0-0.287-0.006-0.569-0.019-0.85 1.281-0.919 2.394-2.075 3.275-3.394z"></path>
  </symbol>
  <symbol id="icon-sina-weibo" viewBox="0 0 32 32">
  <path d="M13.444 28.063c-5.3 0.525-9.875-1.875-10.219-5.35-0.344-3.481 3.675-6.719 8.969-7.244 5.3-0.525 9.875 1.875 10.213 5.35 0.35 3.481-3.669 6.725-8.963 7.244zM24.038 16.519c-0.45-0.137-0.762-0.225-0.525-0.819 0.512-1.287 0.563-2.394 0.006-3.188-1.038-1.481-3.881-1.406-7.137-0.037 0 0-1.025 0.444-0.762-0.363 0.5-1.613 0.425-2.956-0.356-3.738-1.769-1.769-6.469 0.069-10.5 4.1-3.013 3.006-4.763 6.213-4.763 8.981 0 5.288 6.787 8.506 13.425 8.506 8.7 0 14.494-5.056 14.494-9.069 0-2.431-2.044-3.806-3.881-4.375z"></path>
  <path d="M29.819 6.831c-2.1-2.331-5.2-3.219-8.063-2.612v0c-0.663 0.144-1.081 0.794-0.938 1.45 0.144 0.662 0.788 1.081 1.45 0.938 2.038-0.431 4.238 0.2 5.731 1.856s1.9 3.912 1.256 5.888v0c-0.206 0.644 0.144 1.331 0.788 1.544 0.644 0.206 1.331-0.144 1.544-0.787v-0.006c0.9-2.762 0.331-5.938-1.769-8.269z"></path>
  <path d="M26.587 9.75c-1.025-1.137-2.538-1.569-3.925-1.269-0.569 0.119-0.931 0.688-0.813 1.256 0.125 0.569 0.688 0.931 1.25 0.806v0c0.681-0.144 1.419 0.069 1.919 0.619 0.5 0.556 0.637 1.313 0.419 1.975v0c-0.175 0.55 0.125 1.15 0.681 1.331 0.556 0.175 1.15-0.125 1.331-0.681 0.438-1.356 0.163-2.906-0.863-4.037z"></path>
  <path d="M13.738 21.769c-0.188 0.319-0.594 0.469-0.912 0.337-0.319-0.125-0.412-0.488-0.231-0.794 0.188-0.306 0.581-0.456 0.894-0.337 0.313 0.113 0.425 0.469 0.25 0.794zM12.044 23.931c-0.512 0.819-1.613 1.175-2.438 0.8-0.813-0.369-1.056-1.319-0.544-2.119 0.506-0.794 1.569-1.15 2.387-0.806 0.831 0.356 1.1 1.3 0.594 2.125zM13.969 18.144c-2.519-0.656-5.369 0.6-6.463 2.819-1.119 2.262-0.037 4.781 2.506 5.606 2.637 0.85 5.75-0.456 6.831-2.894 1.069-2.394-0.262-4.85-2.875-5.531z"></path>
  </symbol>
  <symbol id="icon-linkedin" viewBox="0 0 32 32">
  <path d="M29 0h-26c-1.65 0-3 1.35-3 3v26c0 1.65 1.35 3 3 3h26c1.65 0 3-1.35 3-3v-26c0-1.65-1.35-3-3-3zM12 26h-4v-14h4v14zM10 10c-1.106 0-2-0.894-2-2s0.894-2 2-2c1.106 0 2 0.894 2 2s-0.894 2-2 2zM26 26h-4v-8c0-1.106-0.894-2-2-2s-2 0.894-2 2v8h-4v-14h4v2.481c0.825-1.131 2.087-2.481 3.5-2.481 2.488 0 4.5 2.238 4.5 5v9z"></path>
  </symbol>
  </defs>
  </svg>

  <header class="site-head"  style="background-image: url(/images/blog/cover.jpg)" >
  <div class="vertical">
    <div class="site-head-content inner">
       <a class="blog-logo"
        href="/"><img src="/images/blog/avatar.png"
          alt="Blog Logo" /></a> 
      <h1 class="blog-title">NOWHERE</h1>
      <h2 class="blog-description">一些碎碎念</h2>
    </div>

    
  </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2021-12-04T21:18:33.000Z" itemprop="datePublished">
          2021-12-04
      </time>
    
    
    | 
    <a href='/tags/daily/'>daily</a>,
    
    <a href='/tags/gears/'>gears</a>
    
    
</span>
    <h1 class="post-title">P340 工作站搭建家庭服务器</h1>
    <section class="post-content">
      <p>最近打算购入 NAS，比较来比较去群晖和 QNAP，突然被同事安利巨硬员工可以打骨折购买 ThinkStation，于是用接近一台 DS920+ 的价格购入了最低配 ThinkStation P340 工作站。基于这台机器，这两天逐渐搭建起了我的家庭服务器。</p>
<h2 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h2><p><img src="/images/211204/thinkstation.jpg"></p>
<p>外观是 ThinkStation 一如既往的低调，体积也没有很大。最低配 P340 带有 10 代 i3 处理器，四核八线程对家庭服务器绰绰有余。内存自带不够看的 4GB，购入两根海盗船组成 20GB 内存。比较良心的是自带 256GB M2 SSD 用来装系统，又购买了两块 WD NAS 红盘作为存储。许多年没碰过正经的塔式计算机了，目测 ThinkStation 用料还是相对丐的（但是绝对足够用）。令我比较印象深刻的是 ThinkStation 的盘位托架非常优雅，不需要螺丝固定，仅需要抽拉和推动拉手来依靠机械结构固定，看来设计时充分考虑到了扩展性。</p>
<h2 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h2><p>物理机操作系统选用 Windows Server 2022。倒不是不熟悉 Linux，主要是<del>为了巨硬员工的尊严</del>。正经的理由是：我需要物理机操作系统只负责底层的存储和虚拟化，其它所有服务均通过部署其上的虚拟机提供，这样不会担心乱搞把全家的服务都搞挂了。Windows Server 的优势在于开箱即用地提供了极为稳定的基础功能：</p>
<ul>
<li>存储池用来管理磁盘 raid</li>
<li>基于网络的文件共享（SMB 与 NFS）</li>
<li>Hyper-V 虚拟机</li>
<li>完善的远程管理（Windows Admin Center，远程桌面）</li>
</ul>
<p><img src="/images/211204/server.png"></p>
<p>通过服务器管理器，所有基础搭建都可以轻松地通过 GUI 设置完成，不需要像 Linux 一样安装额外软件包或者修改 <code>/etc/fstab</code> 之类，个人感觉非常适合家用服务器的部署。存储池、文件共享和 Hyper-V 大家都比较熟悉了，这里多说一下宝藏 <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-admin-center">Windows Admin Center</a>，这个免费的软件实在是太香了。它也是开箱即用地提供了一个完善的 web 管理页面，不仅能够实时查看服务器状态，更能直接管理防火墙、服务、虚拟机、文件甚至注册表项等。</p>
<p><img src="/images/211204/wac.png"></p>
<p>我对 NAS 的使用需求很简单，主要就是提供一个网络驱动器存放文件以及通过 Lightroom 库管理照片，因此 Windows Server 自带的文件共享绰绰有余。其他设备直接挂载来访问，读写速度大概在 90 - 95 MB/s 上下，对于机械盘也勉强可用了。</p>
<p><img src="/images/211204/speedtest.png"></p>
<h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p>其它所有的家庭服务，我通过 Hyper-V 上的三个虚拟机部署和管理。</p>
<h3 id="家庭核心服务"><a href="#家庭核心服务" class="headerlink" title="家庭核心服务"></a>家庭核心服务</h3><p>之前介绍过我家有些服务跑在一台树莓派上，然而对于性能敏感的任务还是很捉急（比如 <code>ffmpeg</code> 解码 Ring 摄像头视频流传输到 HomeKit）。这次我开了一台 Ubuntu Server 2 CPU + 2GB RAM 的虚拟机来接手原来树莓派上智能家居相关服务，主要有负责桥接家里 IoT 设备的 <a target="_blank" rel="noopener" href="https://homebridge.io/">homebridge</a>，将 Chromecast 转为 AirPlay 的 <a target="_blank" rel="noopener" href="https://github.com/philippe44/AirConnect/tree/master/aircast">aircast</a>，和下载文件的 <code>aria2</code> 以及 <a target="_blank" rel="noopener" href="https://github.com/ziahamza/webui-aria2">webui-aria2</a> 作为 UI 管理后台。这些服务全部通过 <code>pm2</code> 来进行管理，在遇到问题时可以自动重启。</p>
<p>在 Windows Server 上，我创建了一个新的文件共享服务用来共享 <code>Downloads</code> 文件夹。在 Ubuntu Server 上，首先安装 <code>cifs-utils</code>，创建 <code>/mnt/downloads</code> 作为挂载点，创建一个 credentials 存放用户名密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;USERNAME</span><br><span class="line">password&#x3D;PASSWORD</span><br></pre></td></tr></table></figure>

<p>修改 <code>/etc/fstab</code> 加上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;SERVER_IP&#x2F;Downloads &#x2F;mnt&#x2F;downloads cifs credentials&#x3D;&#x2F;path&#x2F;to&#x2F;credentials,uid&#x3D;1000,gid&#x3D;1000,iocharset&#x3D;utf8,rw,file_mode&#x3D;0777,dir_mode&#x3D;0777,sec&#x3D;ntlmv2 0 0</span><br></pre></td></tr></table></figure>

<p>然后运行 <code>sudo mount -a</code> 挂载，Ubuntu 即可以读写网络驱动器里的文件了。需要注意的是，此处 <code>USERNAME</code> 的用户必须在 Windows Server 里也设置好对应的读写权限，否则容易出现 <code>permission denied</code> 错误。</p>
<p>对于这些智能家居相关的核心服务，我的想法是将它们物理隔离在一台虚拟机上，创建好检查点，这样一般不需要去动它们，万一因为更新之类的原因搞挂了也可以迅速恢复，避免对家庭使用造成影响。至于其它玩耍的服务可以开新的虚拟机去尽情折腾。</p>
<h3 id="乱七八糟服务"><a href="#乱七八糟服务" class="headerlink" title="乱七八糟服务"></a>乱七八糟服务</h3><p>由于服务器性能较为富裕，我又开了一台 Ubuntu Server 4 CPU + 8GB RAM 的虚拟机跑一些乱七八糟的服务。顺便安利一下 Hyper-V 的动态内存分配，可以允许虚拟机在指定的内存范围内动态变化，因此即使分配了 8GB RAM，在负荷低的情况下虚拟机也只会占用大约 1GB 左右 RAM，不会给宿主机造成太大压力。</p>
<p><img src="/images/211204/hyperv.png"></p>
<p>在这台服务器上，我完全通过 Docker 部署了这些服务：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/photoview/photoview">photoview</a>：家庭相册的 web 浏览界面。没有用 PhotoPrism 是因为我管理完全通过 Lightroom，只需要查看而不需要管理照片。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/mattermost/focalboard">focalboard</a>：个人使用的 Jira，方便追踪一些个人小目标。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/cdr/code-server">code-server</a>：在线版的 VSCode，方便顺手直接改一些服务器上的代码/文件，比如上述所有服务的 <code>docker-compose.yml</code>。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/pawelmalak/flame">flame</a>：简易的 Dashboard，作为所有服务的统一入口。</li>
</ul>
<p><img src="/images/211204/codeserver.png"></p>
<p><img src="/images/211204/dashboard.png"></p>
<h3 id="桌面服务"><a href="#桌面服务" class="headerlink" title="桌面服务"></a>桌面服务</h3><p>最后为了某些桌面应用场景（比如突然需要百度网盘这种流氓软件），我也分配了一台 2 CPU + 8GB RAM 的 Windows Server 服务器并开启了远程桌面。值得一提的是 Windows Server 具有<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows-server/get-started/automatic-vm-activation">虚拟机自动激活</a>的特性，简单配置之后就可放心使用客户机。</p>
<p><img src="/images/211204/rdp.png"></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>以上就是我的家庭服务器搭建，运行至今稳如老狗坚如磐石，总体来说还是满足了我家里的需求的。一些关于家用的想法：</p>
<ul>
<li>不甘于群晖又不放心完全自己搭建的话，成品工作站可能是个不错的折中。</li>
<li>家用服务器可以考虑 Windows Server，提供了很多开箱即用的稳定基础架构（市场部钱结一下谢谢）。</li>
<li>物理机尽可能稳定，保证服务简单。可以只提供 raid、虚拟化和文件共享。</li>
<li>虚拟机物理隔离服务，运用容器等方式保证易于部署和进程自守护。</li>
</ul>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Yubo Qin</h4>
    <p>真不错</p>
</section>
      <section class="share">
  <h4>分享这篇文章</h4>
  <a target="_blank" rel="noopener" href='https://www.linkedin.com/sharing/share-offsite/?url=https://xnth97.github.io/2021/12/04/windows-nas/' onclick="window.open(this.href, 'linkedin-share', 'width=720,height=480');return false;">
    <svg class='icon'>
      <use xlink:href='#icon-linkedin'></use>
    </svg>
    <span class='hidden'>LinkedIn</span>
  </a>
  <a target="_blank" rel="noopener" href='http://service.weibo.com/share/share.php?appkey=&title=P340 工作站搭建家庭服务器&url=https://xnth97.github.io/2021/12/04/windows-nas/&pic=&searchPic=false&style=simple' onclick="window.open(this.href, 'weibo-share', 'width=640,height=360');return false;">
    <svg class='icon'>
      <use xlink:href='#icon-sina-weibo'></use>
    </svg>
    <span class='hidden'>Sina Weibo</span>
  </a>
  <a target="_blank" rel="noopener" href='http://twitter.com/share?url=https://xnth97.github.io/2021/12/04/windows-nas/'
    onclick="window.open(this.href, 'twitter-share', 'width=640,height=480');return false;">
    <svg class="icon">
      <use xlink:href="#icon-twitter"></use>
    </svg>
    <span class="hidden">Twitter</span>
  </a>
  <a target="_blank" rel="noopener" href='https://www.facebook.com/sharer/sharer.php?u=https://xnth97.github.io/2021/12/04/windows-nas/'
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    <svg class="icon">
      <use xlink:href="#icon-facebook2"></use>
    </svg>
    <span class="hidden">Facebook</span>
  </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2021/03/18/tesla-model-y/">
        我的电瓶车时尚时尚最时尚 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <div id="disqus_thread"></div>
    <script>
    // var disqus_config = function () {
    // this.page.url = page.permalink;  // Replace PAGE_URL with your page's canonical URL variable
    // this.page.identifier = page.title; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    // };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://xnth97.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">2021 &copy; Yubo Qin &bull; <a href="/about">关于我</a></section>
  </div>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<script>
  const options = {
    label: '🌓',
    autoMatchOsTheme: true,
  };
  const darkMode = new Darkmode(options);

  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    darkMode.toggle();
  }

  window.matchMedia('(prefers-color-scheme: dark)').addListener('change', e => {
    if (e.matches && !darkMode.isActivated()) {
      darkMode.toggle();
    } else if (darkMode.isActivated()) {
      darkMode.toggle();
    }
  });
</script>
</body>
</html>
